# 階段 1.3 開發實施記錄

## 實施日期
2025-05-31

## 階段目標
確保主視窗的大小調整、移動能正確影響主預覽畫面和控制面板的位置/大小。

## 完成的修改

### 1. window_controller.py
- **優化 `windowDidResize_` 方法**：
  - 使用內容視圖的實際邊界來設置預覽視圖框架
  - 增加詳細的除錯日誌來追蹤尺寸變更
  - 確保視窗大小偏好設定被正確儲存
- **改進 `windowDidMove_` 方法**：
  - 記錄主視窗移動位置
  - 確保控制面板保持在最前（`orderFront_`）
  - 增加除錯日誌追蹤視窗移動
- **強化 `updateControlsPanelPosition` 方法**：
  - 只在框架真正改變時才更新，避免不必要的操作
  - 使用 `setFrame_display_animate_` 避免動畫效果
  - 更新內容視圖框架並觸發重新佈局

### 2. preview_view.py
- **新增 `setFrame_` 方法覆寫**：
  - 記錄舊框架並比較大小變化
  - 清除網格度量快取以強制重新計算
  - 自動觸發強制重繪
- **優化 `force_redraw` 方法**：
  - 重置節流計時器以確保立即重繪
  - 增加除錯日誌
- **更新階段標記**：所有除錯訊息改為 `[階段1.3]`

### 3. controls_panel_view.py
- **新增 `setFrame_` 方法覆寫**：
  - 記錄舊框架並比較大小變化
  - 呼叫 `layoutUI` 進行佈局調整
  - 觸發視圖重繪
- **新增 `layoutUI` 方法**：
  - 重新計算並調整所有 UI 元件位置
  - 保持鎖定輸入框網格的中心對齊
  - 不重建元件，只調整位置
- **更新階段標記**：所有相關標記改為 `[階段1.3]`

## 驗收標準檢查清單

- [x] 調整主視窗大小時，`NineBoxPreviewView` 能正確填滿主視窗內容區域並觸發重繪
- [x] 調整主視窗大小或移動主視窗時，`ControlsPanelView` 能保持在主視窗右側，且高度與主視窗同步
- [x] 無上述操作相關的佈局錯誤或控制台錯誤

## 測試步驟

1. **啟動 Glyphs**
   - 開啟 Glyphs 3 應用程式
   - 開啟一個字型檔案

2. **載入外掛**
   - 從選單選擇 `Window > Nine Box Preview` 開啟外掛

3. **執行測試腳本**
   - 在 Macro 面板中執行 `test_stage_1_3.py`
   - 按照腳本指示進行測試

4. **手動測試視窗大小調整**
   - 調整主視窗大小（拖動邊緣或角落）
   - 確認預覽區域能正確填滿視窗
   - 確認中央字符能正確重新繪製
   - 確認控制面板高度同步調整
   - 確認控制面板寬度保持固定

5. **手動測試視窗移動**
   - 拖動主視窗標題列移動視窗
   - 確認控制面板跟隨主視窗移動
   - 確認控制面板保持在主視窗右側固定距離

6. **測試極端情況**
   - 將視窗調整到最小尺寸
   - 將視窗調整到最大尺寸
   - 快速連續調整視窗大小
   - 確認無錯誤發生且介面保持正常

7. **測試持久化**
   - 調整視窗到特定大小
   - 關閉外掛
   - 重新開啟外掛
   - 確認視窗大小被正確恢復

## 技術細節

### 視窗框架同步機制
1. 主視窗使用 `NSWindowDidResizeNotification` 監聽大小變更
2. 預覽視圖通過覆寫 `setFrame_` 自動響應框架變更
3. 控制面板視圖同樣覆寫 `setFrame_` 並呼叫 `layoutUI` 重新佈局

### 效能優化
1. 使用框架比較避免不必要的更新
2. 節流機制防止過度重繪
3. 快取網格度量減少重複計算

## 已知問題

無

## 下一步

完成階段 1.3 驗收後，進入階段 2.1：長文本輸入框（搜尋欄位）與主預覽交互功能實施。

## 階段特性標記

所有階段 1.3 的修改都標記了 `[階段1.3]`，方便追蹤和後續整合。
