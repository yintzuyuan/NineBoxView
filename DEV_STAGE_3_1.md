# 階段 3-1 開發實施記錄

## 實施日期
2025-06-04

## 階段目標
實現位於九宮格鎖定輸入區中央的全局「鎖頭按鈕 (🔓/🔒)」功能，並使其能正確控制 `lockedChars` 是否應用於預覽。按鈕預設狀態為「🔒 上鎖」。鎖頭狀態切換時，預覽應立即重繪。

## 完成的修改

### 1. controls_panel_view.py

#### 初始化設定
- 將 `isInClearMode` 的初始值從 `True` 改為 `False`（預設為上鎖狀態）

#### 佈局調整
- **移除鎖頭按鈕從 `_create_buttons` 方法**
  - 原本在隨機排列按鈕下方的鎖頭按鈕被移除
  
- **修改 `_create_lock_fields` 方法**
  - 移除了「鎖定位置：」標題（根據開發計畫步驟 4.2）
  - 在 3x3 網格的中央位置（row=1, col=1）創建鎖頭按鈕
  - 設定按鈕使用更大的字體 (16.0)
  - 其他 8 個位置保持為鎖定輸入框

#### 視覺呈現優化
- **修改 `updateLockButton` 方法**
  - 使用純 Unicode 字符（🔓/🔒）而不包含文字
  - 解鎖狀態：使用 🔓 圖示，設定灰色 (`NSColor.systemGrayColor()`)
  - 上鎖狀態：使用 🔒 圖示，設定標籤色 (`NSColor.labelColor()`)
  - 保留了適當的工具提示說明

#### 功能增強
- **修改 `toggleLockMode_` 方法**
  - 註釋掉了原本會禁用/啟用輸入框的邏輯（根據開發計畫，輸入框始終保持可編輯）
  - 新增立即重繪預覽的邏輯：
    - 呼叫 `plugin.generateNewArrangement()` 重新生成排列
    - 呼叫 `plugin.updateInterface(None)` 觸發預覽更新
  - 增加階段標記 `[3.1]` 的除錯日誌

- **修改 `randomizeStub_` 方法**
  - 從存根方法改為實際功能
  - 呼叫 `plugin.randomizeCallback(sender)` 執行隨機排列

#### 佈局同步
- **修改 `layoutUI` 方法**
  - 移除了原本調整獨立鎖頭按鈕的邏輯
  - 在重新佈局九宮格時，正確處理中央的鎖頭按鈕位置

### 2. 其他相關修改

- 所有相關的除錯訊息都標記了 `[3.1]` 以便追蹤
- 確保鎖定輸入框始終保持可編輯狀態
- 確保鎖頭狀態變更時立即觸發預覽重繪

## 驗收標準檢查清單

- [x] 全局鎖頭按鈕正確顯示在九宮格鎖定輸入區的中央
- [x] 使用指定的 Unicode 字符（🔓/🔒）和顏色
- [x] 與周圍輸入框有視覺區分（更大的字體、不同的控件類型）
- [x] 外掛啟動時，鎖頭按鈕預設顯示為「🔒」(上鎖狀態)
- [x] `controlsPanelView.isInClearMode` 預設為 `False`
- [x] 點擊鎖頭按鈕能切換圖示和顏色
- [x] 鎖頭狀態切換時，`NineBoxPreviewView` 立即重繪
- [x] 八個 `LockCharacterField` 始終可編輯
- [x] 鎖頭按鈕為「🔓」時，`generateNewArrangement` 不應用 `lockedChars`
- [x] 鎖頭按鈕為「🔒」時，`generateNewArrangement` 應用 `lockedChars`
- [x] 鎖頭按鈕的狀態不儲存到偏好設定中

## 測試步驟

1. **啟動測試**
   - 開啟 Glyphs 3 應用程式
   - 開啟一個包含多個字符的字型檔案
   - 從選單選擇 `Window > Nine Box Preview` 開啟外掛

2. **執行自動測試腳本**
   - 在 Macro 面板中執行 `test_stage_3_1_script.py`
   - 確認所有自動檢查都通過

3. **手動測試鎖頭按鈕**
   - 確認鎖頭按鈕顯示在九宮格的中央位置
   - 確認初始顯示為 🔒 圖示
   - 點擊按鈕，確認切換為 🔓 圖示
   - 再次點擊，確認切換回 🔒 圖示

4. **測試鎖定功能**
   - 在搜尋欄位輸入 "ABCDEFGH"
   - 在位置 0 的鎖定輸入框輸入 "X"
   - 在位置 3 的鎖定輸入框輸入 "Y"
   - 確認在 🔒 狀態下，位置 0 和 3 顯示 "X" 和 "Y"
   - 切換到 🔓 狀態，確認 "X" 和 "Y" 不再被鎖定
   - 點擊主預覽區域觸發隨機排列，確認所有位置都參與隨機
   - 切換回 🔒 狀態，確認 "X" 和 "Y" 重新被鎖定在位置 0 和 3

5. **測試即時重繪**
   - 每次切換鎖頭狀態時，觀察預覽畫面是否立即更新
   - 確認不需要其他操作就能看到鎖定效果的變化

## 技術細節

### 鎖定狀態管理
- `isInClearMode` 屬性控制鎖定模式
  - `False`：上鎖狀態，應用 `lockedChars`
  - `True`：解鎖狀態，不應用 `lockedChars`
- 狀態變更時自動觸發 `generateNewArrangement` 和 `updateInterface`

### 視覺設計
- 使用 Unicode 表情符號提供直觀的視覺反饋
- 通過顏色（灰色/標籤色）增強狀態區分
- 較大的字體確保按鈕在九宮格中突出

## 已知問題與修正

### 問題：鎖頭功能邏輯錯誤
- **發現日期**：2025-06-04
- **問題描述**：`_get_lock_state()` 方法的預設返回值為 `True`（解鎖），與控制面板的預設值 `isInClearMode = False`（上鎖）不一致
- **修正方案**：將 `_get_lock_state()` 的預設返回值改為 `False`，並增加詳細的註釋和除錯日誌

## 下一步

完成階段 3-1 驗收後，進入階段 3-2：實現「清空欄位」圖示按鈕功能。

## 階段特性標記

所有階段 3-1 的修改都標記了 `[3.1]`，方便追蹤和後續整合。
