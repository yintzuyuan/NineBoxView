# 視窗焦點同步改進總結

## 問題描述
控制面板在收合和展開後會失去與主視窗的焦點同步功能，變回原本的模式。

## 解決方案
完全移除舊的浮動視窗模式，全面改用新的視窗焦點同步方式（子視窗模式）。

## 核心改進

### 1. 新增統一的子視窗關係管理方法
- 添加 `_ensure_child_window_relationship()` 方法
- 確保每次都正確建立主視窗與控制面板的子視窗關係
- 先移除現有關係再重新建立，避免重複添加

### 2. 修改控制面板配置方法
- 更新 `_configure_controls_panel_window()` 方法
- 移除註釋掉的 `setLevel_(NSFloatingWindowLevel)` 設定
- 統一調用 `_ensure_child_window_relationship()` 建立關係

### 3. 改進控制面板顯示邏輯
- 修改 `showControlsPanel()` 方法
- 每次顯示時都確保子視窗關係正確
- 添加更詳細的日志記錄

### 4. 增強控制面板重建機制
- 添加 `rebuildControlsPanelIfNeeded()` 方法
- 統一處理控制面板的重建和子視窗關係建立
- 在 `makeKeyAndOrderFront()` 中使用統一的重建方法

### 5. 強化控制面板按鈕操作
- 改進 `controlsPanelAction_()` 方法
- 確保切換時重新建立控制面板並正確設置子視窗關係

### 6. 增強視窗事件處理
- 修改 `windowDidMove_()` 和 `windowDidResize_()` 方法
- 在視窗移動和調整大小時確保子視窗關係

## 技術細節

### 子視窗關係的重要性
使用 `addChildWindow_ordered_` 建立的子視窗關係具有以下優勢：
1. 自動跟隨主視窗的焦點狀態
2. 主視窗最小化時子視窗也會隱藏
3. 主視窗關閉時子視窗自動關閉
4. 共享視窗級別和顯示行為

### 關鍵改進點
1. **一致性**: 所有控制面板操作都使用相同的子視窗建立邏輯
2. **容錯性**: 在建立新關係前先移除現有關係，避免重複
3. **及時性**: 在每次可能丟失關係的操作後都重新確保關係
4. **完整性**: 涵蓋控制面板的創建、顯示、重建等所有場景

## 測試建議
1. 測試控制面板的收合和展開
2. 測試主視窗的移動和調整大小
3. 測試外掛的關閉和重新開啟
4. 測試主視窗失去和獲得焦點的行為
5. 驗證控制面板始終跟隨主視窗的焦點狀態

## 向後兼容性
所有變更都保持了原有的 API 接口，不會影響現有的使用方式。
